<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåç InfraTrack Global - Submit Report</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='grad' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' style='stop-color:%231eaf75;stop-opacity:1' /><stop offset='100%' style='stop-color:%23667eea;stop-opacity:1' /></linearGradient></defs><rect width='100' height='100' rx='20' fill='url(%23grad)'/><text x='50' y='70' font-size='60' text-anchor='middle' fill='white'>üåç</text></svg>" type="image/svg+xml">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="report.css">
  
</head>
<body>
    <div class="animated-bg"></div>
    <div class="grid-overlay"></div>
    
    <div class="content-wrapper">
        <!-- ==================== TOP NAVIGATION ==================== -->
        <div class="top-bar">
            <div class="logo-section">
                <button class="toggle-btn" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="logo-icon">üåç</div>
            </div>
            
            <div class="menu-buttons" id="topMenu">
                <a href="homepage.html">
                    <i class="fas fa-home"></i> <span>Home</span>
                </a>
                <a href="Account.html">
                    <i class="fas fa-user"></i> <span>Account</span>
                </a>
                <a href="aboutUs.html">
                    <i class="fas fa-info-circle"></i> <span>About</span>
                </a>
            </div>
        </div>

        <!-- ==================== PAGE HEADER ==================== -->
        <div class="page-header">
            <h1>üìù Report an Issue</h1>
            <p>Help your community by reporting infrastructure problems</p>
        </div>

        <!-- ==================== REPORT FORM ==================== -->
        <div class="report-container">
            <form class="report-form" id="reportForm">
                
                <!-- SERVICE TYPE SELECTION -->
                <div class="service-selector">
                    <h3>What service is affected? <span style="color: #e74c3c;">*</span></h3>
                    <div class="service-options">
                        <label class="service-option">
                            <input type="radio" name="service_type" value="power" required>
                            <div class="service-icon">‚ö°</div>
                            <div class="service-name">Power</div>
                        </label>
                        <label class="service-option">
                            <input type="radio" name="service_type" value="water" required>
                            <div class="service-icon">üíß</div>
                            <div class="service-name">Water</div>
                        </label>
                        <label class="service-option">
                            <input type="radio" name="service_type" value="internet" required>
                            <div class="service-icon">üì±</div>
                            <div class="service-name">Internet</div>
                        </label>
                    </div>
                </div>

                <!-- ISSUE TITLE -->
                <div class="form-section">
                    <h3><i class="fas fa-heading"></i> Issue Title <span style="color: #e74c3c;">*</span></h3>
                    <div class="form-group">
                        <input type="text" name="title" placeholder="Brief title for the issue" required maxlength="100">
                    </div>
                </div>

                <!-- STATUS SELECTION -->
                <div class="form-section">
                    <h3><i class="fas fa-info-circle"></i> Current Status <span style="color: #e74c3c;">*</span></h3>
                    <div class="status-options">
                        <label class="status-option selected">
                            <input type="radio" name="status" value="outage" required checked>
                            <div class="status-icon">üî¥</div>
                            <div>Complete Outage</div>
                        </label>
                        <label class="status-option">
                            <input type="radio" name="status" value="partial" required>
                            <div class="status-icon">üü°</div>
                            <div>Partial Service</div>
                        </label>
                        <label class="status-option">
                            <input type="radio" name="status" value="restored" required>
                            <div class="status-icon">‚úÖ</div>
                            <div>Service Restored</div>
                        </label>
                    </div>
                </div>

                <!-- LOCATION INFORMATION -->
                <div class="form-section">
                    <h3><i class="fas fa-map-marker-alt"></i> Location <span style="color: #e74c3c;">*</span></h3>
                    
                    <div class="form-group">
                        <label>Country</label>
                        <input type="text" name="country" id="countryInput" placeholder="e.g., Cameroon" required>
                    </div>
                    
                    <div class="form-group">
                        <label>City</label>
                        <input type="text" name="city" id="cityInput" placeholder="e.g., Yaound√©" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Address/Area (Optional)</label>
                        <input type="text" name="location_address" id="addressInput" placeholder="e.g., Avenue Kennedy, Bastos">
                    </div>
                    
                    <div class="location-detector">
                        <button type="button" class="location-btn" onclick="detectLocation()">
                            <i class="fas fa-crosshairs"></i> Use My Location
                        </button>
                        <span class="location-text" id="locationText">Or enter manually above</span>
                    </div>
                </div>

                <!-- DESCRIPTION -->
                <div class="form-section">
                    <h3><i class="fas fa-comment-alt"></i> Description <span style="color: #e74c3c;">*</span></h3>
                    <div class="form-group">
                        <textarea name="description" required placeholder="Please provide detailed information about the issue..." rows="5"></textarea>
                    </div>
                </div>

                <!-- SEVERITY LEVEL -->
                <div class="form-section">
                    <h3><i class="fas fa-exclamation-triangle"></i> Severity</h3>
                    <div class="form-group">
                        <select name="severity">
                            <option value="low">Low - Minor inconvenience</option>
                            <option value="medium" selected>Medium - Significant impact</option>
                            <option value="high">High - Critical situation</option>
                            <option value="critical">Critical - Emergency</option>
                        </select>
                    </div>
                </div>

                <!-- IMAGE UPLOAD -->
                <div class="form-section">
                    <h3><i class="fas fa-camera"></i> Upload Image (Optional)</h3>
                    <div class="form-group">
                        <input type="file" name="image" accept="image/*">
                        <small style="opacity: 0.7;">JPG, PNG, or JPEG. Max 5MB.</small>
                    </div>
                </div>

                <!-- SUBMIT BUTTON -->
                <button type="submit" class="submit-btn" id="submitBtn">
                    <i class="fas fa-paper-plane"></i> Submit Report
                </button>
            </form>
        </div>

        <!-- ==================== SUCCESS MESSAGE MODAL ==================== -->
        <div class="success-message" id="successMessage">
            <div class="success-icon">‚úÖ</div>
            <h2>Report Submitted Successfully!</h2>
            <p>Thank you for helping your community. Your report will help others stay informed.</p>
            <button class="view-reports-btn" onclick="window.location.href='report_feeds.html'">
                View All Reports
            </button>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const API_BASE = `${window.location.origin}/api`;
        let currentLocation = { latitude: null, longitude: null };

        // ==================== MOBILE MENU TOGGLE ====================
        const menuToggle = document.getElementById('menuToggle');
        const topMenu = document.getElementById('topMenu');

        menuToggle.addEventListener('click', function() {
            topMenu.classList.toggle('mobile-visible');
            const icon = this.querySelector('i');
            icon.className = topMenu.classList.contains('mobile-visible') ? 'fas fa-times' : 'fas fa-bars';
        });

        // ==================== SERVICE SELECTION ====================
        document.querySelectorAll('.service-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.service-option').forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                this.querySelector('input[type="radio"]').checked = true;
            });
        });

        // ==================== STATUS SELECTION ====================
        document.querySelectorAll('.status-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.status-option').forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                this.querySelector('input[type="radio"]').checked = true;
            });
        });

        // ==================== LOCATION DETECTION ====================
        function detectLocation() {
            const locationText = document.getElementById('locationText');
            const locationBtn = document.querySelector('.location-btn');
            
            locationBtn.disabled = true;
            locationText.textContent = 'Detecting location...';
            locationText.style.color = '#3498db';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        currentLocation.latitude = position.coords.latitude;
                        currentLocation.longitude = position.coords.longitude;
                        
                        locationText.textContent = `üìç Location detected: ${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)}`;
                        locationText.style.color = '#27ae60';
                        locationBtn.disabled = false;
                        locationBtn.innerHTML = '<i class="fas fa-check"></i> Location Detected';
                        
                        reverseGeocode(position.coords.latitude, position.coords.longitude);
                    },
                    function(error) {
                        locationText.textContent = '‚ùå Could not detect location. Please enter manually.';
                        locationText.style.color = '#e74c3c';
                        locationBtn.disabled = false;
                        console.error('Geolocation error:', error);
                    }
                );
            } else {
                locationText.textContent = '‚ùå Geolocation not supported. Please enter manually.';
                locationText.style.color = '#e74c3c';
                locationBtn.disabled = false;
            }
        }

        // ==================== REVERSE GEOCODING ====================
        async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const data = await response.json();
                
                if (data.address) {
                    document.getElementById('countryInput').value = data.address.country || '';
                    document.getElementById('cityInput').value = data.address.city || data.address.town || data.address.village || '';
                    document.getElementById('addressInput').value = data.display_name || '';
                }
            } catch (error) {
                console.error('Reverse geocoding error:', error);
            }
        }

        // ==================== FORM SUBMISSION ====================
        document.getElementById('reportForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

            const formData = new FormData(this);

            // Add user ID if logged in
            const userId = localStorage.getItem('userId');
            if (userId) {
                formData.append('user_id', userId);
            }

            // Add location coordinates if available
            if (currentLocation.latitude && currentLocation.longitude) {
                formData.append('location_latitude', currentLocation.latitude);
                formData.append('location_longitude', currentLocation.longitude);
            }

            // Log form data for debugging
            console.log('üìù Submitting report with data:');
            for (let [key, value] of formData.entries()) {
                console.log(`  ${key}: ${value}`);
            }

            try {
                console.log('üöÄ Sending request to:', `${API_BASE}/reports`);
                
                const response = await fetch(`${API_BASE}/reports`, {
                    method: 'POST',
                    body: formData
                });

                console.log('üì° Response status:', response.status);

                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const textResponse = await response.text();
                    console.error('‚ùå Server returned non-JSON response:', textResponse);
                    throw new Error('Server error: Backend not responding correctly. Check if server is running on port 3000');
                }

                const data = await response.json();
                console.log('‚úÖ Response data:', data);

                if (!response.ok) {
                    throw new Error(data.message || 'Failed to submit report');
                }

                // Show success message
                document.getElementById('successMessage').classList.add('show');

                // Reset form after 3 seconds
                setTimeout(() => {
                    this.reset();
                    document.querySelectorAll('.service-option, .status-option')
                        .forEach(opt => opt.classList.remove('selected'));
                    document.querySelector('.status-option').classList.add('selected');
                    currentLocation = { latitude: null, longitude: null };
                    document.getElementById('locationText').textContent = 'Or enter manually above';
                    document.querySelector('.location-btn').innerHTML = '<i class="fas fa-crosshairs"></i> Use My Location';
                    document.getElementById('successMessage').classList.remove('show');
                }, 3000);

            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('‚ùå Error: ' + error.message + `\n\nPlease check:\n1. Backend server is running on ${window.location.origin}\n2. Open browser console (F12) for more details`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Report';
            }
        });
    </script>
</body>
</html>